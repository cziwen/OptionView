# Roll Calculator - Payoff Diagram å®ç°

## ğŸ¯ ç”¨æˆ·éœ€æ±‚

**é—®é¢˜**ï¼šè®©ç”¨æˆ·è¾“å…¥æ•°å­—æ¥è®¡ç®—ä¸¤ç§æƒ…å†µå¤ªéº»çƒ¦

**è§£å†³æ–¹æ¡ˆ**ï¼šåªéœ€è¦è¾“å…¥ New Strike å’Œ New Premiumï¼Œå±•ç¤ºä¸€ä¸ª Payoff Diagram

---

## ğŸ“Š Payoff Diagram åŠŸèƒ½

### æ ¸å¿ƒæ€æƒ³

**ä¸éœ€è¦ç”¨æˆ·è¾“å…¥é¢„æœŸè‚¡ä»· (S_T)**ï¼Œè€Œæ˜¯ï¼š
- è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªè‚¡ä»·èŒƒå›´
- å¯¹æ¯ä¸ªè‚¡ä»·è®¡ç®— P/L
- ç”¨å›¾è¡¨å¯è§†åŒ–å±•ç¤º
- ç”¨æˆ·å¯ä»¥äº¤äº’æŸ¥çœ‹ä»»æ„è‚¡ä»·ä¸‹çš„ P/L

### è¾“å…¥ç®€åŒ–

**ä¹‹å‰**ï¼ˆä¸¤ç§æƒ…æ™¯åˆ†æï¼‰ï¼š
```
âŒ éœ€è¦è¾“å…¥:
  - Old Position
  - Old Outcome
  - New Strike
  - New Premium
  - Expected Stock Price (å¿…éœ€ï¼Œç”¨äºè®¡ç®—)
```

**ç°åœ¨**ï¼ˆPayoff Diagramï¼‰ï¼š
```
âœ… åªéœ€è¦è¾“å…¥:
  - Old Position
  - Old Outcome
  - New Strike
  - New Premium
  - (ä¸éœ€è¦é¢„æœŸè‚¡ä»·ï¼)
```

---

## ğŸ¨ å®ç°ç»†èŠ‚

### æ–°å¢æ–‡ä»¶ï¼š`RollPayoffDiagramView.swift`

#### 1. RollPayoffCalculator

**æ ¸å¿ƒå‡½æ•°**ï¼š
```swift
static func calculateRollPayoff(
    oldStrategy: OptionStrategy,
    oldAssumption: OldLegAssumption,
    newStrike: Double,
    newPremium: Double,
    priceRange: [Double]
) -> [RollPayoffPoint]
```

**è®¡ç®—é€»è¾‘**ï¼š
```
For æ¯ä¸ª S_T in priceRange:
    1. è®¡ç®—æ—§ä»“ P/Lï¼ˆå›ºå®šçš„ï¼‰
    2. è®¡ç®—æ–°ä»“ P/Lï¼ˆæ ¹æ® S_Tï¼‰
    3. Total P/L = Old + New
    4. ç”Ÿæˆ RollPayoffPoint(S_T, Total P/L)
```

**æ–°ä»“ P/L è®¡ç®—**ï¼ˆå…³é”®ï¼‰ï¼š
```swift
Covered Call:
    if S_T >= newStrike:
        // è¢«è¡Œæƒï¼šåœ¨ strike å–å‡º
        P/L = (strike - cost) Ã— shares + premium
    else:
        // åˆ°æœŸï¼šP/L = (S_T - cost) Ã— shares + premium
        
Naked Call:
    if S_T >= newStrike:
        // è¢«è¡Œæƒ
        Loss = (S_T - strike) Ã— shares
        P/L = premium - Loss
    else:
        // åˆ°æœŸ
        P/L = premium

CSP:
    if S_T <= newStrike:
        // è¢«è¡Œæƒ
        P/L = (S_T - strike) Ã— shares + premium
    else:
        // åˆ°æœŸ
        P/L = premium
```

#### 2. RollPayoffDiagramView

**SwiftUI Chart å±•ç¤º**ï¼š
```swift
Chart {
    // é›¶çº¿å‚è€ƒ
    RuleMark(y: 0) // Break-even line
    
    // æ—§ Strike å‚è€ƒçº¿
    RuleMark(x: oldStrike)
    
    // æ–° Strike å‚è€ƒçº¿
    RuleMark(x: newStrike)
    
    // P/L æ›²çº¿
    LineMark(x: S_T, y: P/L)
    
    // ç›ˆåˆ©åŒºåŸŸï¼ˆç»¿è‰²ï¼‰
    AreaMark(where P/L >= 0)
    
    // äºæŸåŒºåŸŸï¼ˆçº¢è‰²ï¼‰
    AreaMark(where P/L < 0)
    
    // é€‰ä¸­ç‚¹
    RuleMark(x: selectedPrice)
}
```

**äº¤äº’åŠŸèƒ½**ï¼š
- `.chartXSelection($selectedPrice)` - ç‚¹å‡»/æ»‘åŠ¨é€‰æ‹©è‚¡ä»·
- æ˜¾ç¤ºé€‰ä¸­ç‚¹çš„è¯¦ç»†ä¿¡æ¯
- æ˜¾ç¤ºé€‰ä¸­ç‚¹çš„æƒ…æ™¯è¯´æ˜

---

## ğŸ¬ ç”¨æˆ·ä½“éªŒ

### ä½¿ç”¨æµç¨‹

```
1. Roll Calculator ä¸»é¡µé¢
   â”œâ”€ é€‰æ‹©æ—§ä»“
   â”œâ”€ é€‰æ‹©ç»“å±€
   â”œâ”€ è¾“å…¥æ–° Strike
   â”œâ”€ è¾“å…¥æ–° Premium
   â””â”€ ç‚¹å‡» "View Payoff Diagram" âœ¨

2. Payoff Diagram é¡µé¢
   â”œâ”€ ğŸ“ˆ å›¾è¡¨è‡ªåŠ¨å±•ç¤º P/L æ›²çº¿
   â”œâ”€ ğŸ‘† ç‚¹å‡»/æ»‘åŠ¨ä»»æ„è‚¡ä»·
   â”œâ”€ ğŸ“Š å®æ—¶æ˜¾ç¤ºè¯¥ä»·æ ¼çš„ P/L
   â”œâ”€ ğŸ“ æ˜¾ç¤ºæƒ…æ™¯è¯´æ˜
   â””â”€ ğŸ¯ æ˜¾ç¤ºå…³é”®æŒ‡æ ‡
```

### Payoff Diagram å±•ç¤ºå†…å®¹

#### ä¸»å›¾è¡¨
```
      P/L
       â†‘
    +500|     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       |    /
       |   /
     0 |â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ S_T
       | /
   -500|/
       
    æ©™è‰²è™šçº¿: Old Strike ($150)
    è“è‰²è™šçº¿: New Strike ($155)
    ç»¿è‰²åŒºåŸŸ: ç›ˆåˆ©
    çº¢è‰²åŒºåŸŸ: äºæŸ
```

#### äº¤äº’é€‰ä¸­ç‚¹
```
é€‰ä¸­ S_T = $158:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ At S_T = $158              â”‚
â”‚ Total P/L: +$1,150 ğŸŸ¢      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Above old strike         â”‚
â”‚ âœ“ Above new strike         â”‚
â”‚   â†’ New option exercised   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å…³é”®æŒ‡æ ‡å¡ç‰‡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Key Metrics         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Max Profit: $1,350  â”‚
â”‚ Max Loss: $-350     â”‚
â”‚ Break-Even: $147.50 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Roll è¯¦æƒ…å¡ç‰‡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Roll Details         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Old: CC @ $150       â”‚
â”‚ New: CC @ $155       â”‚
â”‚ Premium: $1.50       â”‚
â”‚ Contracts: 1         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¡ å…³é”®ä¼˜åŠ¿

### 1. **ä¸éœ€è¦çŒœæµ‹ S_T**
- âŒ ä¹‹å‰ï¼šç”¨æˆ·å¿…é¡»è¾“å…¥é¢„æœŸè‚¡ä»·
- âœ… ç°åœ¨ï¼šçœ‹æ•´ä¸ªèŒƒå›´çš„ P/L

### 2. **ä¸€ç›®äº†ç„¶**
- âŒ ä¹‹å‰ï¼šä¸¤ä¸ªæ•°å­—ï¼ˆScenario 1 å’Œ 2ï¼‰
- âœ… ç°åœ¨ï¼šä¸€æ¡æ›²çº¿ï¼ˆæ‰€æœ‰å¯èƒ½ï¼‰

### 3. **äº¤äº’æ¢ç´¢**
- âŒ ä¹‹å‰ï¼šå›ºå®šçš„ä¸¤ä¸ªç‚¹
- âœ… ç°åœ¨ï¼šæ»‘åŠ¨æŸ¥çœ‹ä»»æ„è‚¡ä»·

### 4. **è§†è§‰åŒ–**
- âŒ ä¹‹å‰ï¼šçº¯æ•°å­—
- âœ… ç°åœ¨ï¼šå›¾è¡¨ã€é¢œè‰²ã€åŒºåŸŸ

### 5. **æƒ…æ™¯è¯´æ˜**
- è‡ªåŠ¨è¯†åˆ«é€‰ä¸­ç‚¹çš„æƒ…æ™¯
- "Above strike" / "Below strike"
- "Will be exercised" / "Will expire"

---

## ğŸ“ˆ å®é™…ä¾‹å­

### Example: Covered Call Roll

**è¾“å…¥**ï¼š
```
Old Position:
  - AAPL Covered Call
  - Strike: $150, Cost: $145
  - Premium: $2, Expired

New Position:
  - Strike: $155
  - Premium: $1.50
```

**Payoff Diagram å±•ç¤º**ï¼š
```
P/L æ›²çº¿ç‰¹ç‚¹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åœ¨ $145 ä»¥ä¸‹ï¼šäºæŸï¼ˆè‚¡ç¥¨è´¬å€¼ï¼‰   â”‚
â”‚  $145-$150: ç›ˆåˆ©å¢åŠ              â”‚
â”‚  $150-$155: ç»§ç»­å¢åŠ              â”‚
â”‚  $155 ä»¥ä¸Šï¼šå›ºå®šåœ¨æœ€å¤§ç›ˆåˆ©        â”‚
â”‚             ï¼ˆè¢«è¡Œæƒåœ¨ $155ï¼‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Break-Even: $147.50
Max Profit: $1,350 (at S_T >= $155)
Max Loss: -$300 (at S_T = $0)
```

**ç”¨æˆ·äº¤äº’**ï¼š
```
ç‚¹å‡» S_T = $152:
  â†’ P/L = $1,050
  â†’ è¯´æ˜: "Above old strike, below new strike"
  â†’ æƒ…æ™¯: "New option will expire, stock held"

ç‚¹å‡» S_T = $158:
  â†’ P/L = $1,350
  â†’ è¯´æ˜: "Above both strikes"
  â†’ æƒ…æ™¯: "New option exercised, stock sold"
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### ä»·æ ¼èŒƒå›´ç”Ÿæˆ
```swift
// æ™ºèƒ½èŒƒå›´
minPrice = max(0, min(oldStrike, newStrike) - 30%)
maxPrice = max(oldStrike, newStrike) + 30%
steps = 100  // 100 ä¸ªç‚¹ï¼Œè¶³å¤Ÿå¹³æ»‘
```

### æ›²çº¿è®¡ç®—
```swift
// å‘é‡åŒ–è®¡ç®—
priceRange.map { ST in
    RollPayoffPoint(
        stockPrice: ST,
        totalPnL: calculatePnLAtPrice(..., ST)
    )
}
```

### Chart ç‰¹æ€§
```swift
// æ¸å˜è‰²
.foregroundStyle(.linearGradient(
    colors: [.green, .yellow, .red],
    startPoint: .top,
    endPoint: .bottom
))

// åŒºåŸŸå¡«å……
AreaMark(where totalPnL >= 0)
    .foregroundStyle(.green.opacity(0.1))

// äº¤äº’é€‰æ‹©
.chartXSelection(value: $selectedPrice)
```

---

## ğŸ“± UI é›†æˆ

### Roll Calculator ä¸»é¡µé¢

**æ–°å¢æŒ‰é’®**ï¼š
```swift
Section {
    NavigationLink {
        RollPayoffDiagramView(...)
    } label: {
        HStack {
            ğŸ“Š Icon
            "View Payoff Diagram"
            "Visualize P/L at different stock prices"
        }
    }
} header: {
    "Visual Analysis"
} footer: {
    "See how P/L changes with different stock prices"
}
```

**ä½ç½®**ï¼šåœ¨"Realized"éƒ¨åˆ†ä¹‹åï¼Œ"Scenario"éƒ¨åˆ†ä¹‹å‰

---

## âœ… å®ç°å®Œæˆ

### æ–°å¢æ–‡ä»¶
- âœ… `RollPayoffDiagramView.swift` - Payoff Diagram è§†å›¾

### ä¿®æ”¹æ–‡ä»¶
- âœ… `RollCalculatorView.swift` - æ·»åŠ å¯¼èˆªæŒ‰é’®

### åŠŸèƒ½ç‰¹æ€§
- âœ… è‡ªåŠ¨ç”Ÿæˆä»·æ ¼èŒƒå›´
- âœ… è®¡ç®—æ‰€æœ‰è‚¡ä»·çš„ P/L
- âœ… SwiftUI Charts å¯è§†åŒ–
- âœ… äº¤äº’å¼é€‰æ‹©è‚¡ä»·
- âœ… å®æ—¶æ˜¾ç¤ºè¯¦æƒ…
- âœ… æƒ…æ™¯è‡ªåŠ¨è¯´æ˜
- âœ… å…³é”®æŒ‡æ ‡å±•ç¤º
- âœ… ç›ˆäºåŒºåŸŸå¡«å……
- âœ… Strike å‚è€ƒçº¿
- âœ… Break-even è®¡ç®—

---

## ğŸ‰ æ€»ç»“

**ä¹‹å‰çš„æ–¹å¼**ï¼š
```
ç”¨æˆ·è¾“å…¥ S_T = $158
â†’ çœ‹åˆ° Scenario 1 å’Œ 2 çš„ç»“æœ
â†’ æƒ³çœ‹å…¶ä»–ä»·æ ¼ï¼Ÿé‡æ–°è¾“å…¥ï¼ğŸ˜“
```

**ç°åœ¨çš„æ–¹å¼**ï¼š
```
ç”¨æˆ·ç‚¹å‡» "View Payoff Diagram"
â†’ çœ‹åˆ°å®Œæ•´çš„ P/L æ›²çº¿ ğŸ“ˆ
â†’ æ»‘åŠ¨æŸ¥çœ‹ä»»æ„ä»·æ ¼ï¼ğŸ˜Š
â†’ ä¸€ç›®äº†ç„¶ï¼Œä¸éœ€è¦çŒœï¼âœ¨
```

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ¯ **ç®€åŒ–è¾“å…¥**ï¼šä¸éœ€è¦é¢„æœŸè‚¡ä»·
- ğŸ“Š **å¯è§†åŒ–**ï¼šå›¾è¡¨æ¯”æ•°å­—ç›´è§‚
- ğŸ” **æ¢ç´¢æ€§**ï¼šå¯ä»¥çœ‹æ‰€æœ‰å¯èƒ½
- ğŸ¨ **ç¾è§‚**ï¼šé¢œè‰²ã€æ¸å˜ã€åŒºåŸŸ
- ğŸ’¡ **æ•™è‚²æ€§**ï¼šç†è§£ P/L å¦‚ä½•å˜åŒ–

**å®Œç¾å®ç°ç”¨æˆ·éœ€æ±‚ï¼** ğŸŠ

---

**ç‰ˆæœ¬**: Payoff Diagram ç‰ˆ  
**æ—¥æœŸ**: 2025-11-08  
**çŠ¶æ€**: âœ… å®Œæˆ
